# Week 2 - EPIC 2: Contract Management

## Session 6 (2026-02-16) - Contract Model + API (Backend)

**Focus**: ForeignKey relationships, nested API routes, cross-field validation

**What I built:**
- Contract model with ForeignKey to Employee (1:N relationship)
- TextChoices for contract_type (determinato, indeterminato, stagista) and CCNL
- DecimalField for RAL (exact-precision currency)
- Nullable end_date (NULL = active contract)
- ContractSerializer with cross-field validation (end_date > start_date)
- ContractViewSet with nested URL routes (/api/employees/{id}/contracts/)
- 9 API tests (22 total backend)

**What I learned:**
- ForeignKey = SQL FOREIGN KEY REFERENCES, but with `related_name` for reverse access
- `employee.contracts.all()` replaces explicit JOINs (Django ORM magic via related_name)
- `on_delete=CASCADE`: what happens when parent is deleted (CASCADE, SET_NULL, PROTECT)
- NULL vs sentinel (9999-12-31) for "no end date": app DBs use NULL, DWH uses sentinels (SCD Type 2)
- `null=True` + `blank=True` needed together for optional non-string fields (DB layer + validation layer)
- `DateField` for dates (no time component) vs `DateTimeField` for timestamps
- `DecimalField` maps to PostgreSQL `NUMERIC` — exact arithmetic, no floating-point errors
- `validate()` (no field name): cross-field validation with access to all parsed fields
- `validate_<field>()`: single-field validation only
- `data.get()` in validate(): safe access for PATCH requests where not all fields are sent
- Nested ViewSet pattern: `get_queryset` filters by URL param, `perform_create` injects parent
- `get_object_or_404`: shortcut that returns 404 if parent doesn't exist
- `.as_view({"get": "list", "post": "create"})`: manual HTTP method → ViewSet action mapping
- `<int:employee_pk>` in URL → `self.kwargs["employee_pk"]` in view (like SP parameter from URL)
- Django auto-creates INDEX on FK columns (unlike SQL Server)
- `sqlmigrate` command: shows actual SQL generated by a migration
- Model class names: singular in Django (Contract, not Contracts)

**Key pattern: SQL → Django ORM mapping (new concepts):**
| SQL Server | Django ORM |
|---|---|
| `FOREIGN KEY REFERENCES Employees(id)` | `models.ForeignKey(Employee, on_delete=CASCADE)` |
| `JOIN Contracts ON emp.id = c.employee_id` | `employee.contracts.all()` via related_name |
| `ON DELETE CASCADE` | `on_delete=models.CASCADE` |
| `NUMERIC(10,2)` | `DecimalField(max_digits=10, decimal_places=2)` |
| `DATE NULL` | `DateField(null=True, blank=True)` |
| `CHECK (end_date > start_date)` | `validate(self, data)` cross-field validation |
| `WHERE employee_id = @param` (in SP) | `self.kwargs["employee_pk"]` (from URL) |
| `CREATE INDEX ON (employee_id)` | Automatic on ForeignKey fields |

**Architecture pattern: nested API routes:**
| HTTP | URL | ViewSet Action | SQL Equivalent |
|---|---|---|---|
| GET | /api/employees/{id}/contracts/ | list | SELECT * WHERE employee_id = @id |
| POST | /api/employees/{id}/contracts/ | create | INSERT INTO ... (employee_id = @id) |
| GET | /api/employees/{id}/contracts/{pk}/ | retrieve | SELECT * WHERE id = @pk |
| PATCH | /api/employees/{id}/contracts/{pk}/ | partial_update | UPDATE SET ... WHERE id = @pk |
| DELETE | /api/employees/{id}/contracts/{pk}/ | destroy | DELETE WHERE id = @pk |

**Next steps:**
- [x] EPIC 2 Frontend: Contract list + create/edit forms — done in Session 7
- [ ] EPIC 2 Phase 2: File upload (PDF) + S3 storage

---

## Session 7 (2026-02-18) - Contract CRUD Frontend

**Focus**: Vue components for nested resources, route params, form validation alignment

**What I built:**
- api.js: 5 contract API functions (fetchContract, fetchContracts, createContract, updateContract, deleteContract) with guard clauses
- ContractList.vue: table with Promise.all parallel fetch, active/closed badges, RAL currency formatting, delete flow with ConfirmDialog
- ContractForm.vue: dual-mode create/edit, dropdown choices matching backend TextChoices, optional end_date with payload cleanup
- 3 View wrappers (ContractListView, ContractCreateView, ContractEditView)
- Vue Router: 3 nested routes with :employeeId and :contractId params
- EmployeeList.vue: "Contratti" link per employee row
- 22 new frontend tests (12 ContractList + 10 ContractForm)

**What I learned:**
- Promise.all: fetch multiple APIs in parallel (like running two SQL queries simultaneously)
- Intl.NumberFormat('it-IT'): browser-native currency formatting (no external library needed)
- Derived state: active/closed badge from `end_date === null` (no redundant DB column)
- Route params are STRINGS: must convert with `Number()` before passing as typed Number prop
- `<input type="number">` + v-model: Vue auto-converts to Number (not String) — caught by failing tests
- Frontend/backend choices MUST match: `<select>` options must be identical to Django TextChoices values — "stage" ≠ "stagista" causes 400 error
- Optional field UX: remove both HTML `required` attribute AND asterisk from label
- Payload cleanup before API call: empty string '' should be removed (delete), not sent as '' (which != null)
- Hard delete messaging: "irreversibile" (vs "reversibile" for soft delete)
- Guard clauses (fail-fast): `if (!employeeId) throw new Error(...)` prevents silent bugs with `undefined` in URL

**Key pattern: EmployeeForm → ContractForm differences:**
| Aspect | EmployeeForm | ContractForm |
|---|---|---|
| Props | employee (Object/null) | employeeId (Number) + contract (Object/null) |
| Immutable field | email (disabled in edit) | None |
| API call | createEmployee(payload) | createContract(employeeId, payload) |
| Optional field | department (string, blank ok) | end_date (date, needs '' → delete cleanup) |
| Cancel link | / (employee list) | /employees/{id}/contracts (contract list) |
| Choices | 1 select (role) | 2 selects (contract_type, ccnl) |

**Mistakes caught in code review:**
1. `result` not declared with `let` (strict mode ReferenceError)
2. Select options didn't match backend TextChoices ("stage" vs "stagista")
3. end_date marked as required (should be optional for active contracts)
4. end_date '' cleanup only in edit branch (needed in both)
5. "Annulla" link pointed to / instead of contracts list
6. `_nonFieldErrors` key didn't match template's `non_field_errors`
7. Unused imports and refs (onMounted, useRoute, fetchEmployee, employee, loading, error)

**Next steps:**
- [ ] EPIC 2 Phase 2: File upload (PDF) + S3 storage
- [ ] EPIC 3: Onboarding automation
