# Week 2 - EPIC 2: Contract Management

## Session 6 (2026-02-16) - Contract Model + API (Backend)

**Focus**: ForeignKey relationships, nested API routes, cross-field validation

**What I built:**
- Contract model with ForeignKey to Employee (1:N relationship)
- TextChoices for contract_type (determinato, indeterminato, stagista) and CCNL
- DecimalField for RAL (exact-precision currency)
- Nullable end_date (NULL = active contract)
- ContractSerializer with cross-field validation (end_date > start_date)
- ContractViewSet with nested URL routes (/api/employees/{id}/contracts/)
- 9 API tests (22 total backend)

**What I learned:**
- ForeignKey = SQL FOREIGN KEY REFERENCES, but with `related_name` for reverse access
- `employee.contracts.all()` replaces explicit JOINs (Django ORM magic via related_name)
- `on_delete=CASCADE`: what happens when parent is deleted (CASCADE, SET_NULL, PROTECT)
- NULL vs sentinel (9999-12-31) for "no end date": app DBs use NULL, DWH uses sentinels (SCD Type 2)
- `null=True` + `blank=True` needed together for optional non-string fields (DB layer + validation layer)
- `DateField` for dates (no time component) vs `DateTimeField` for timestamps
- `DecimalField` maps to PostgreSQL `NUMERIC` — exact arithmetic, no floating-point errors
- `validate()` (no field name): cross-field validation with access to all parsed fields
- `validate_<field>()`: single-field validation only
- `data.get()` in validate(): safe access for PATCH requests where not all fields are sent
- Nested ViewSet pattern: `get_queryset` filters by URL param, `perform_create` injects parent
- `get_object_or_404`: shortcut that returns 404 if parent doesn't exist
- `.as_view({"get": "list", "post": "create"})`: manual HTTP method → ViewSet action mapping
- `<int:employee_pk>` in URL → `self.kwargs["employee_pk"]` in view (like SP parameter from URL)
- Django auto-creates INDEX on FK columns (unlike SQL Server)
- `sqlmigrate` command: shows actual SQL generated by a migration
- Model class names: singular in Django (Contract, not Contracts)

**Key pattern: SQL → Django ORM mapping (new concepts):**
| SQL Server | Django ORM |
|---|---|
| `FOREIGN KEY REFERENCES Employees(id)` | `models.ForeignKey(Employee, on_delete=CASCADE)` |
| `JOIN Contracts ON emp.id = c.employee_id` | `employee.contracts.all()` via related_name |
| `ON DELETE CASCADE` | `on_delete=models.CASCADE` |
| `NUMERIC(10,2)` | `DecimalField(max_digits=10, decimal_places=2)` |
| `DATE NULL` | `DateField(null=True, blank=True)` |
| `CHECK (end_date > start_date)` | `validate(self, data)` cross-field validation |
| `WHERE employee_id = @param` (in SP) | `self.kwargs["employee_pk"]` (from URL) |
| `CREATE INDEX ON (employee_id)` | Automatic on ForeignKey fields |

**Architecture pattern: nested API routes:**
| HTTP | URL | ViewSet Action | SQL Equivalent |
|---|---|---|---|
| GET | /api/employees/{id}/contracts/ | list | SELECT * WHERE employee_id = @id |
| POST | /api/employees/{id}/contracts/ | create | INSERT INTO ... (employee_id = @id) |
| GET | /api/employees/{id}/contracts/{pk}/ | retrieve | SELECT * WHERE id = @pk |
| PATCH | /api/employees/{id}/contracts/{pk}/ | partial_update | UPDATE SET ... WHERE id = @pk |
| DELETE | /api/employees/{id}/contracts/{pk}/ | destroy | DELETE WHERE id = @pk |

**Next steps:**
- [ ] EPIC 2 Frontend: Contract list + create/edit forms
- [ ] EPIC 2 Phase 2: File upload (PDF) + S3 storage
